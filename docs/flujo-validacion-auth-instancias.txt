Flujo actual de autenticación/licencia al crear instancia
========================================================

Objetivo
--------
Evitar modo Demo y asegurarnos de que el token usado en Minecraft Services sea válido y vigente.

Flujo correcto (obligatorio)
----------------------------
1) Microsoft OAuth:
   - Se obtiene microsoft_access_token (+ refresh_token).

2) Xbox Live:
   - Con microsoft_access_token se pide token Xbox Live.

3) XSTS:
   - Con token Xbox Live se pide token XSTS.

4) Minecraft login_with_xbox:
   - Con uhs + xsts_token se obtiene minecraft_access_token.

5) Validación premium:
   - GET /entitlements/mcstore con Bearer minecraft_access_token.
   - Debe devolver items no vacío.

6) Validación de perfil:
   - GET /minecraft/profile con el mismo Bearer.
   - id y name deben coincidir con la sesión activa.

Corrección aplicada al error 401
--------------------------------
Problema observado:
- Durante creación de instancia, /entitlements/mcstore devolvía 401 Unauthorized.

Causa más frecuente:
- minecraft_access_token expirado o inválido al momento de validar en backend.

Mitigación implementada:
- Antes de validar entitlements, si el token está por expirar (<= 60s), se hace refresh oficial completo:
  Microsoft refresh -> Xbox Live -> XSTS -> login_with_xbox.
- Si /entitlements/mcstore devuelve 401, se intenta refresh oficial y se reintenta la consulta.
- Se valida nuevamente licencia y perfil con el token activo renovado.

Qué revisar si vuelve a fallar
------------------------------
1) Que exista microsoft_refresh_token en la sesión.
2) Que el flujo use SIEMPRE el minecraft_access_token (no ms token, no xsts token) para endpoints de Minecraft Services.
3) Que reloj del sistema no esté desfasado (expiración prematura).
4) Que profile.id y profile.name sigan coincidiendo con la sesión guardada.

Señales esperadas en logs
-------------------------
- "access_token próximo a expirar; refrescando..."
- "access_token de Minecraft renovado correctamente."
- "refresh completado; reintentando validación de licencia."
- "Licencia oficial de Minecraft verificada (entitlements/mcstore)."
- "Perfil oficial verificado: <name> (<id>)"
