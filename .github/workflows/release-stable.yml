name: Release Stable (Tauri)

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - uses: dtolnay/rust-toolchain@stable

      - name: Install deps
        run: npm ci

      - name: Build + Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: ${{ github.ref_name }}
          releaseDraft: false
          prerelease: false

      - name: Create Windows updater bundles (.msi.zip/.nsis.zip)
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"

          # Busca los instaladores generados por Tauri
          $msi = Get-ChildItem -Recurse "src-tauri\target\release\bundle" -Filter *.msi | Select-Object -First 1
          $exe = Get-ChildItem -Recurse "src-tauri\target\release\bundle" -Filter *setup.exe | Select-Object -First 1

          if (-not $msi -and -not $exe) {
            throw "No Windows installers found (.msi or *setup.exe) in src-tauri/target/release/bundle"
          }

          # Carpeta de salida
          $outDir = "updater-bundles"
          New-Item -ItemType Directory -Force $outDir | Out-Null

          if ($msi) {
            $msiZip = Join-Path $outDir ($msi.BaseName + ".msi.zip")
            if (Test-Path $msiZip) { Remove-Item $msiZip -Force }
            Compress-Archive -Path $msi.FullName -DestinationPath $msiZip
            Write-Host "Created: $msiZip"
          }

          if ($exe) {
            $exeZip = Join-Path $outDir ($exe.BaseName + ".nsis.zip")
            if (Test-Path $exeZip) { Remove-Item $exeZip -Force }
            Compress-Archive -Path $exe.FullName -DestinationPath $exeZip
            Write-Host "Created: $exeZip"
          }

          Get-ChildItem $outDir

      - name: Upload updater bundles to release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            updater-bundles/*.zip

      - name: Generate stable manifest
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $ErrorActionPreference = 'Stop'

          $tag = "${{ github.ref_name }}"
          $repo = "${{ github.repository }}"
          $api = "https://api.github.com/repos/$repo/releases/tags/$tag"
          $headers = @{ Authorization = "Bearer $env:GITHUB_TOKEN"; "User-Agent" = "gh-actions" }

          $release = Invoke-RestMethod -Headers $headers -Uri $api

          $windowsUpdaterAssets = $release.assets | Where-Object {
            $_.name -match '(?i)(nsis|setup|msi).*\.zip$' -and
            ($_.name -match '(?i)x64|x86_64|amd64' -or $_.name -notmatch '(?i)arm64|aarch64')
          }

          $updaterAsset = $windowsUpdaterAssets | Where-Object {
            $_.name -match '(?i)x64|x86_64|amd64'
          } | Select-Object -First 1

          if (-not $updaterAsset) {
            $updaterAsset = $windowsUpdaterAssets | Select-Object -First 1
          }

          if (-not $updaterAsset) {
            throw "No Windows updater bundle (.nsis.zip/.msi.zip) found in release $tag. Assets: $($release.assets.name -join ', ')"
          }

          $sigAsset = $release.assets | Where-Object {
            $_.name -eq "$($updaterAsset.name).sig"
          } | Select-Object -First 1

          if (-not $sigAsset) {
            throw "No signature asset found for $($updaterAsset.name)"
          }

          $signature = (Invoke-RestMethod -Headers $headers -Uri $sigAsset.browser_download_url).Trim()

          $manifest = @{
            version = $tag.TrimStart('v')
            notes = "Stable update $tag"
            pub_date = $release.published_at
            platforms = @{
              "windows-x86_64" = @{
                signature = $signature
                url = $updaterAsset.browser_download_url
              }
            }
          } | ConvertTo-Json -Depth 8

          New-Item -ItemType Directory -Force -Path updates | Out-Null
          $manifest | Out-File -Encoding utf8 updates/stable.json

      - name: Publish updates/ to gh-pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_branch: gh-pages
          publish_dir: updates
          destination_dir: updates
          keep_files: true
